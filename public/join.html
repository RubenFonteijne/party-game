<!doctype html>
<html lang="nl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Party Game — Join</title>
    <link rel="stylesheet" href="/css/style.css">
    </head>
<body>
  <div class="card">
    <h1>Meedoen</h1>
    <p class="muted">Room: <strong id="roomCode"></strong></p>

    <div id="stepName">
      <label for="name">Jouw naam</label>
      <input id="name" placeholder="Bijv. Ruben" maxlength="24" />
      <button id="joinBtn">Join</button>
      <p class="error" id="joinError"></p>
    </div>

    <div id="stepLobby" style="display:none;">
      <p class="ok">Verbonden als <strong id="myName"></strong>.</p>
      <button id="readyBtn">Ik ben ready ✅</button>
      <button id="unreadyBtn" class="secondary" style="display:none;">Toch niet ready</button>
      <p class="muted" id="status"></p>
    </div>

    <div id="stepAnswer" style="display:none;">
      <p class="muted"><strong>Beantwoord de stelling op het scherm</strong></p>
      <div class="field">
        <label>Mijn antwoord</label>
        <input id="selfAnswer" placeholder="Typ jouw antwoord..." maxlength="80"/>
      </div>

      <div class="field" id="predictFields"></div>

      <button id="submitBtn">Versturen</button>
      <button id="editBtn" class="secondary" style="display:none;">Aanpassen</button>

      <p class="muted small" id="answerHint"></p>
    </div>

    <div id="stepWait" style="display:none;">
      <p class="muted"><strong>Even wachten…</strong></p>
      <p class="muted" id="waitText">Host toont zo de antwoorden op het scherm.</p>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const roomCode = location.pathname.split("/").pop().toUpperCase();
    document.getElementById("roomCode").textContent = roomCode;

    const socket = io();

    let playerId = null;
    let myName = "";
    let currentPlayers = [];
    let submitted = false;

    // join
    const nameEl = document.getElementById("name");
    document.getElementById("joinBtn").onclick = () => {
      document.getElementById("joinError").textContent = "";
      socket.emit("joinRoom", { roomCode, name: nameEl.value.trim() });
    };

    socket.on("joinError", (msg) => {
      document.getElementById("joinError").textContent = msg;
    });

    socket.on("joined", ({ playerId: pid, name }) => {
      playerId = pid;
      myName = name;

      document.getElementById("stepName").style.display = "none";
      document.getElementById("stepLobby").style.display = "block";
      document.getElementById("myName").textContent = myName;
      document.getElementById("status").textContent = "Wachten tot iedereen ready is…";
    });

    // ready toggle
    const readyBtn = document.getElementById("readyBtn");
    const unreadyBtn = document.getElementById("unreadyBtn");

    readyBtn.onclick = () => {
      socket.emit("setReady", { roomCode, playerId, ready: true });
      readyBtn.style.display = "none";
      unreadyBtn.style.display = "block";
    };

    unreadyBtn.onclick = () => {
      socket.emit("setReady", { roomCode, playerId, ready: false });
      unreadyBtn.style.display = "none";
      readyBtn.style.display = "block";
    };

    // submit
    const submitBtn = document.getElementById("submitBtn");
    const editBtn = document.getElementById("editBtn");

    submitBtn.onclick = () => {
      const self = document.getElementById("selfAnswer").value.trim();

      const predicts = {};
      document.querySelectorAll("[data-predict-id]").forEach(inp => {
        predicts[inp.getAttribute("data-predict-id")] = inp.value.trim();
      });

      socket.emit("submitAnswers", { roomCode, playerId, self, predicts });
      submitted = true;

      submitBtn.style.display = "none";
      editBtn.style.display = "block";
      document.getElementById("answerHint").textContent = "Verstuurd ✅ Wachten op de rest…";
    };

    editBtn.onclick = () => {
      // MVP: laat bewerken toe door opnieuw te submitten (overschrijft server submission)
      submitted = false;
      submitBtn.style.display = "block";
      editBtn.style.display = "none";
      document.getElementById("answerHint").textContent = "";
    };

    // room state
    socket.on("roomState", (state) => {
      currentPlayers = state.players || [];

      if (!playerId) return;

      const me = currentPlayers.find(p => p.id === playerId);

      // schermen wisselen op basis van game state
      if (state.state === "LOBBY") {
        show("stepLobby");
        if (me) {
          document.getElementById("status").textContent = me.ready
            ? "Ready! ✅ Wachten op host…"
            : "Niet ready. Klik ready als je wil starten.";
        }
        submitted = false;
        resetAnswerUI();
      }

      if (state.state === "ANSWERING") {
        show("stepAnswer");
        buildPredictFields(currentPlayers, playerId);

        if (submitted) {
          submitBtn.style.display = "none";
          editBtn.style.display = "block";
          document.getElementById("answerHint").textContent = "Verstuurd ✅ Wachten op de rest…";
        } else {
          submitBtn.style.display = "block";
          editBtn.style.display = "none";
          document.getElementById("answerHint").textContent = "";
        }
      }

      if (state.state === "REVEAL" || state.state === "SCOREBOARD") {
        show("stepWait");
        document.getElementById("waitText").textContent =
          (state.state === "REVEAL")
            ? "Host toont nu de antwoorden op het scherm…"
            : "Scoreboard op het scherm!";
      }
    });

    function show(id) {
      ["stepName", "stepLobby", "stepAnswer", "stepWait"].forEach(x => {
        document.getElementById(x).style.display = (x === id) ? "block" : "none";
      });
    }

    function buildPredictFields(players, myId) {
      const wrap = document.getElementById("predictFields");
      wrap.innerHTML = "";

      players
        .filter(p => p.id !== myId)
        .forEach(p => {
          const div = document.createElement("div");
          div.className = "row";
          div.innerHTML = `
            <label>Wat denk ik dat <strong>${escapeHtml(p.name)}</strong> invult?</label>
            <input data-predict-id="${p.id}" placeholder="Jouw voorspelling..." maxlength="80"/>
          `;
          wrap.appendChild(div);
        });
    }

    function resetAnswerUI() {
      document.getElementById("selfAnswer").value = "";
      document.getElementById("predictFields").innerHTML = "";
      document.getElementById("answerHint").textContent = "";
      submitBtn.style.display = "block";
      editBtn.style.display = "none";
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
  </script>
</body>
</html>
