<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Say so! — Join</title>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <!-- dezelfde streaks als host (als je ze in host.html had). Als je ze niet meer gebruikt: mag je dit weglaten -->
  <div class="streak"></div>
  <div class="streak s2"></div>
  <div class="streak s3"></div>

  <div class="header">
    <h1 class="title" id="headerTitle">Meedoen</h1>
    <div class="subtitle">Room: <span id="roomCode"></span></div>
  </div>

  <div class="wrap">
    <div class="panel panel--narrow">
      <div class="panelInner" style="grid-template-columns: 1fr;">
        <div class="card">

          <!-- STEP: NAME -->
          <div id="stepName">
            <div class="cardTitle">Jouw naam</div>
            <div class="kicker">Vul je naam in en join de room.</div>

            <div class="formStack">
              <div>
                <label class="label" for="name">Naam</label>
                <input class="input" id="name" placeholder="Bijv. Ruben" maxlength="24" />
                <div class="errorText" id="joinError"></div>
              </div>

              <button class="btn btnFull" id="joinBtn">Join</button>
              <div class="hint">Tip: zet je telefoon rechtop voor sneller invullen.</div>
            </div>
          </div>

          <!-- STEP: LOBBY -->
          <div id="stepLobby" style="display:none;">
            <div class="cardTitle">Je bent verbonden</div>
            <div class="kicker">Als iedereen klaar is, start de host de ronde.</div>

            <div class="successText">Verbonden als <strong id="myName"></strong>.</div>
            <div class="divider"></div>

            <div class="btnRowJoin">
              <button class="btn btnFull" id="readyBtn">Ik ben ready ✅</button>
              <button class="btn btnSecondary btnFull" id="unreadyBtn" style="display:none;">Toch niet ready</button>
            </div>

            <div class="hint" id="status" style="margin-top:10px;"></div>
          </div>

          <!-- STEP: ANSWER -->
          <div id="stepAnswer" style="display:none;">
            <div class="cardTitle">Invullen</div>
            <div class="kicker"><strong>Beantwoord de stelling op het scherm.</strong></div>

            <div class="formStack">
              <div id="selfAnswerContainer">
                <label class="label" for="selfAnswer">Mijn antwoord</label>
                <input class="input" id="selfAnswer" placeholder="Typ jouw antwoord…" maxlength="80"/>
                <div id="selfToggleContainer" style="display:none;"></div>
              </div>

              <div>
                <div class="sectionHeader">Mijn voorspellingen</div>
                <div class="predictList" id="predictFields"></div>
              </div>

              <div class="btnRowJoin">
                <button class="btn btnFull" id="submitBtn" disabled>Versturen</button>
                <button class="btn btnSecondary btnFull" id="editBtn" style="display:none;">Aanpassen</button>
              </div>

              <div class="hint" id="answerHint"></div>
            </div>
          </div>

          <!-- STEP: WAIT -->
          <div id="stepWait" style="display:none;">
            <div class="cardTitle">Even wachten…</div>
            <div class="kicker">De host toont zo de antwoorden op het scherm.</div>
            <div class="hint" id="waitText">Wachten…</div>
          </div>

          <!-- STEP: GAME FINISHED -->
          <div id="stepFinished" style="display:none;">
            <div class="cardTitle">Game afgerond!</div>
            <div class="kicker">De game is klaar. Scan de QR code van een nieuwe game om opnieuw mee te doen.</div>
            <div class="btnRowJoin" style="margin-top: 24px;">
              <button class="btn btnFull" id="openCameraBtn">Open camera</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const roomCode = location.pathname.split("/").pop().toUpperCase();
    document.getElementById("roomCode").textContent = roomCode;

    const socket = io();

    let playerId = null;
    let myName = "";
    let currentPlayers = [];
    let submitted = false;
    let lastRound = 0;
    let lastQuestion = 0;
    let wasInGame = false;

    // NEW: track last question so we can reset UI when a new question starts
    let lastQuestionKey = null;

    // join
    const nameEl = document.getElementById("name");
    document.getElementById("joinBtn").onclick = () => {
      document.getElementById("joinError").textContent = "";
      socket.emit("joinRoom", { roomCode, name: nameEl.value.trim() });
    };

    // Add input listener for self answer validation
    const selfAnswerInput = document.getElementById("selfAnswer");
    if (selfAnswerInput) {
      selfAnswerInput.addEventListener("input", checkFormValidity);
    }

    socket.on("joinError", (msg) => {
      document.getElementById("joinError").textContent = msg;
    });

    socket.on("joined", ({ playerId: pid, name }) => {
      playerId = pid;
      myName = name;

      // Update header title met spelernaam
      document.getElementById("headerTitle").textContent = myName;

      show("stepLobby");
      document.getElementById("myName").textContent = myName;
      document.getElementById("status").textContent = "Wachten tot iedereen ready is…";
    });

    // ready toggle
    const readyBtn = document.getElementById("readyBtn");
    const unreadyBtn = document.getElementById("unreadyBtn");

    readyBtn.onclick = () => {
      socket.emit("setReady", { roomCode, playerId, ready: true });
      readyBtn.style.display = "none";
      unreadyBtn.style.display = "block";
    };

    unreadyBtn.onclick = () => {
      socket.emit("setReady", { roomCode, playerId, ready: false });
      unreadyBtn.style.display = "none";
      readyBtn.style.display = "block";
    };

    // submit
    const submitBtn = document.getElementById("submitBtn");
    const editBtn = document.getElementById("editBtn");

    submitBtn.onclick = () => {
      let self;
      if (currentTheme === "18+") {
        const selfToggle = document.getElementById("selfToggle");
        self = selfToggle ? (selfToggle.dataset.value === "true" ? "true" : "false") : "false";
      } else {
        self = document.getElementById("selfAnswer").value.trim();
      }

      const predicts = {};
      if (currentTheme === "18+") {
        document.querySelectorAll("[data-predict-toggle]").forEach(toggle => {
          const playerId = toggle.getAttribute("data-predict-toggle");
          predicts[playerId] = toggle.dataset.value === "true" ? "true" : "false";
        });
      } else {
        document.querySelectorAll("[data-predict-id]").forEach(inp => {
          predicts[inp.getAttribute("data-predict-id")] = inp.value.trim();
        });
      }

      socket.emit("submitAnswers", { roomCode, playerId, self, predicts });
      submitted = true;

      // Disable alle inputs en behoud waarden
      disableAnswerUI(currentTheme);

      submitBtn.style.display = "none";
      editBtn.style.display = "block";
      document.getElementById("answerHint").textContent = "Verstuurd ✅ Wachten op de rest…";
    };

    editBtn.onclick = () => {
      submitted = false;
      
      // Enable alle inputs weer
      enableAnswerUI(currentTheme);

      submitBtn.style.display = "block";
      editBtn.style.display = "none";
      document.getElementById("answerHint").textContent = "";
    };

    // room state
    socket.on("roomState", (state) => {
      currentPlayers = state.players || [];
      currentTheme = state.theme || "default";
      if (!playerId) return;

      const me = currentPlayers.find(p => p.id === playerId);

      if (state.state === "LOBBY") {
        // Check if game is finished (back to lobby after completing all questions)
        const currentRound = state.round || 1;
        const currentQ = state.question || 0;
        const totalQuestions = state.questionsPerRound || 10;
        
        // If we were in a game and now back to lobby with question 0, game is finished
        if (wasInGame && currentQ === 0 && lastQuestion >= totalQuestions) {
          // Game is finished
          show("stepFinished");
          wasInGame = false;
        } else {
          show("stepLobby");
          if (me) {
            document.getElementById("status").textContent = me.ready
              ? "Ready! ✅ Wachten op host…"
              : "Niet ready. Klik ready als je wil starten.";
          }
          wasInGame = false;
        }

        // reset everything when going back to lobby
        submitted = false;
        lastQuestionKey = null;
        resetAnswerUI();
      }
      
      // Track if we're in a game
      if (state.state === "ANSWERING" || state.state === "REVEAL" || state.state === "SCOREBOARD") {
        wasInGame = true;
      }
      
      // Track round and question for game finished detection
      lastRound = state.round || 1;
      lastQuestion = state.question || 0;

      if (state.state === "ANSWERING") {
        // NEW: detect new question and reset old answers/predictions
        const questionKey = `${state.round || 1}-${state.question || 0}`;
        if (questionKey !== lastQuestionKey) {
          lastQuestionKey = questionKey;
          submitted = false;
          resetAnswerUI();
        }

        show("stepAnswer");
        setupAnswerUI(currentTheme);
        buildPredictFields(currentPlayers, playerId, currentTheme);

        if (submitted) {
          // Disable alle inputs en behoud waarden
          disableAnswerUI(currentTheme);
          
          submitBtn.style.display = "none";
          editBtn.style.display = "block";
          document.getElementById("answerHint").textContent = "Verstuurd ✅ Wachten op de rest…";
        } else {
          // Enable alle inputs
          enableAnswerUI(currentTheme);
          
          submitBtn.style.display = "block";
          editBtn.style.display = "none";
          document.getElementById("answerHint").textContent = "";
          
          // Check validatie en update knop state
          checkFormValidity();
        }
      }

      if (state.state === "REVEAL" || state.state === "SCOREBOARD") {
        show("stepWait");
        document.getElementById("waitText").textContent =
          (state.state === "REVEAL")
            ? "Host toont nu de antwoorden op het scherm…"
            : "Scoreboard op het scherm!";
      }
    });

    function show(id) {
      ["stepName", "stepLobby", "stepAnswer", "stepWait", "stepFinished"].forEach(x => {
        document.getElementById(x).style.display = (x === id) ? "block" : "none";
      });
    }

    // Open camera for QR code scanning
    document.getElementById("openCameraBtn").onclick = () => {
      // Redirect to homepage where they can scan QR code
      window.location.href = "/";
    };

    function setupAnswerUI(theme) {
      const selfAnswerInput = document.getElementById("selfAnswer");
      const selfAnswerContainer = document.getElementById("selfAnswerContainer");
      const selfToggleContainer = document.getElementById("selfToggleContainer");
      
      if (theme === "18+") {
        selfAnswerInput.style.display = "none";
        selfToggleContainer.style.display = "block";
        
        if (!document.getElementById("selfToggle")) {
          // Check if we have a saved value, default to false
          const savedValue = selfAnswerInput.value === "true" || selfAnswerInput.value === "TRUE" ? true : false;
          selfToggleContainer.innerHTML = createToggle("selfToggle", "", savedValue);
          const toggle = document.getElementById("selfToggle");
          if (toggle) {
            toggle.addEventListener("click", () => {
              toggleTrueFalse(toggle);
              checkFormValidity();
            });
          }
        }
      } else {
        selfAnswerInput.style.display = "block";
        selfToggleContainer.style.display = "none";
      }
    }

    function buildPredictFields(players, myId, theme) {
      const wrap = document.getElementById("predictFields");
      
      if (theme === "18+") {
        // Behoud bestaande toggle states
        const existingData = {};
        document.querySelectorAll("[data-predict-toggle]").forEach(toggle => {
          const id = toggle.getAttribute("data-predict-toggle");
          existingData[id] = {
            value: toggle.dataset.value === "true",
            disabled: toggle.classList.contains("disabled")
          };
        });
        
        // Verwijder toggles voor spelers die er niet meer zijn
        const currentPlayerIds = players.filter(p => p.id !== myId).map(p => p.id);
        document.querySelectorAll("[data-predict-toggle]").forEach(toggle => {
          const id = toggle.getAttribute("data-predict-toggle");
          if (!currentPlayerIds.includes(id)) {
            toggle.closest(".predictItem")?.remove();
          }
        });
        
        // Voeg nieuwe toggles toe of update bestaande
        players
          .filter(p => p.id !== myId)
          .forEach(p => {
            let existingToggle = document.querySelector(`[data-predict-toggle="${p.id}"]`);
            
            if (existingToggle) {
              // Update alleen de naam als die veranderd is
              const whoEl = existingToggle.previousElementSibling;
              if (whoEl && whoEl.classList.contains("predictWho")) {
                whoEl.textContent = escapeHtml(p.name);
              }
            } else {
              // Maak nieuw toggle
              const div = document.createElement("div");
              div.className = "predictItem";
              div.setAttribute("data-theme", "18+");
              const savedData = existingData[p.id] || { value: false };
              div.innerHTML = `
                <div class="predictWho">${escapeHtml(p.name)}</div>
                ${createToggle(`predict-${p.id}`, "", savedData.value, p.id)}
              `;
              wrap.appendChild(div);
              
              const toggle = document.getElementById(`predict-${p.id}`);
              if (toggle) {
                toggle.addEventListener("click", () => {
                  toggleTrueFalse(toggle);
                  checkFormValidity();
                });
                if (savedData.disabled) toggle.classList.add("disabled");
              }
            }
          });
      } else {
        // Originele text input logica
        const existingData = {};
        document.querySelectorAll("[data-predict-id]").forEach(inp => {
          const id = inp.getAttribute("data-predict-id");
          existingData[id] = {
            value: inp.value,
            disabled: inp.disabled
          };
        });
        
        const currentPlayerIds = players.filter(p => p.id !== myId).map(p => p.id);
        document.querySelectorAll("[data-predict-id]").forEach(inp => {
          const id = inp.getAttribute("data-predict-id");
          if (!currentPlayerIds.includes(id)) {
            inp.closest(".predictItem")?.remove();
          }
        });
        
        players
          .filter(p => p.id !== myId)
          .forEach(p => {
            let existingInput = document.querySelector(`[data-predict-id="${p.id}"]`);
            
            if (existingInput) {
              const whoEl = existingInput.previousElementSibling;
              if (whoEl && whoEl.classList.contains("predictWho")) {
                whoEl.textContent = `Het antwoord van ${escapeHtml(p.name)} is...`;
              }
            } else {
              const div = document.createElement("div");
              div.className = "predictItem";
              // Set data-theme attribute for CSS styling (not 18+)
              div.setAttribute("data-theme", "text");
              const savedData = existingData[p.id] || {};
              div.innerHTML = `
                <div class="predictWho">Het antwoord van ${escapeHtml(p.name)} is...</div>
                <input class="input" data-predict-id="${p.id}" placeholder="Jouw voorspelling…" maxlength="80" value="${escapeHtml(savedData.value || "")}" ${savedData.disabled ? 'disabled' : ''}/>
              `;
              wrap.appendChild(div);
              
              // Add input listener for validation
              const input = div.querySelector("input");
              if (input && !savedData.disabled) {
                input.addEventListener("input", checkFormValidity);
              }
            }
          });
      }
    }

    function createToggle(id, label, value, predictId = null) {
      const isTrue = value === true || value === "true";
      const dataAttr = predictId ? `data-predict-toggle="${predictId}"` : "";
      return `
        <div class="toggleWrapper">
          ${label ? `<div class="toggleLabel">${label}</div>` : ""}
          <div class="toggleSwitch ${isTrue ? 'active' : ''}" id="${id}" ${dataAttr} data-value="${isTrue}">
            <div class="toggleOption ${!isTrue ? 'selected' : ''}">Niet gedaan</div>
            <div class="toggleOption ${isTrue ? 'selected' : ''}">Gedaan</div>
          </div>
        </div>
      `;
    }

    function toggleTrueFalse(toggle) {
      if (toggle.classList.contains("disabled")) return;
      const isTrue = toggle.dataset.value === "true";
      toggle.dataset.value = (!isTrue).toString();
      toggle.classList.toggle("active");
      toggle.querySelectorAll(".toggleOption").forEach(opt => opt.classList.toggle("selected"));
    }

    function disableAnswerUI(theme) {
      if (theme === "18+") {
        const selfToggle = document.getElementById("selfToggle");
        if (selfToggle) selfToggle.classList.add("disabled");
        document.querySelectorAll("[data-predict-toggle]").forEach(toggle => {
          toggle.classList.add("disabled");
        });
      } else {
        document.getElementById("selfAnswer").disabled = true;
        document.querySelectorAll("[data-predict-id]").forEach(inp => {
          inp.disabled = true;
        });
      }
    }

    function enableAnswerUI(theme) {
      if (theme === "18+") {
        const selfToggle = document.getElementById("selfToggle");
        if (selfToggle) selfToggle.classList.remove("disabled");
        document.querySelectorAll("[data-predict-toggle]").forEach(toggle => {
          toggle.classList.remove("disabled");
        });
      } else {
        document.getElementById("selfAnswer").disabled = false;
        document.querySelectorAll("[data-predict-id]").forEach(inp => {
          inp.disabled = false;
        });
      }
    }

    function checkFormValidity() {
      const submitBtn = document.getElementById("submitBtn");
      let isValid = true;

      if (currentTheme === "18+") {
        // Check self toggle
        const selfToggle = document.getElementById("selfToggle");
        if (!selfToggle) isValid = false;
        
        // Check all prediction toggles
        document.querySelectorAll("[data-predict-toggle]").forEach(toggle => {
          if (toggle.classList.contains("disabled")) return; // Skip disabled
          // Toggles always have a value (true or false), so they're always valid
        });
      } else {
        // Check self answer
        const selfAnswer = document.getElementById("selfAnswer").value.trim();
        if (!selfAnswer) isValid = false;
        
        // Check all prediction inputs
        document.querySelectorAll("[data-predict-id]").forEach(inp => {
          if (inp.disabled) return; // Skip disabled
          if (!inp.value.trim()) isValid = false;
        });
      }

      submitBtn.disabled = !isValid;
    }

    // Add event listeners for input changes
    document.addEventListener("input", (e) => {
      if (e.target.id === "selfAnswer" || e.target.hasAttribute("data-predict-id")) {
        checkFormValidity();
      }
    });

    // Add event listener for toggle changes
    document.addEventListener("click", (e) => {
      if (e.target.closest(".toggleSwitch") && !e.target.closest(".toggleSwitch.disabled")) {
        setTimeout(checkFormValidity, 100); // Small delay to let toggle update
      }
    });

    function resetAnswerUI() {
      document.getElementById("selfAnswer").value = "";
      document.getElementById("predictFields").innerHTML = "";
      document.getElementById("selfToggleContainer").innerHTML = "";
      document.getElementById("answerHint").textContent = "";
      submitBtn.style.display = "block";
      editBtn.style.display = "none";
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
  </script>
</body>
</html>
