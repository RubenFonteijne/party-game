<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Party Game — Join</title>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <!-- dezelfde streaks als host (als je ze in host.html had). Als je ze niet meer gebruikt: mag je dit weglaten -->
  <div class="streak"></div>
  <div class="streak s2"></div>
  <div class="streak s3"></div>

  <div class="header">
    <h1 class="title" id="headerTitle">Meedoen</h1>
    <div class="subtitle">Room: <span id="roomCode"></span></div>
  </div>

  <div class="wrap">
    <div class="panel panel--narrow">
      <div class="panelInner" style="grid-template-columns: 1fr;">
        <div class="card">

          <!-- STEP: NAME -->
          <div id="stepName">
            <div class="cardTitle">Jouw naam</div>
            <div class="kicker">Vul je naam in en join de room.</div>

            <div class="formStack">
              <div>
                <label class="label" for="name">Naam</label>
                <input class="input" id="name" placeholder="Bijv. Ruben" maxlength="24" />
                <div class="errorText" id="joinError"></div>
              </div>

              <button class="btn btnFull" id="joinBtn">Join</button>
              <div class="hint">Tip: zet je telefoon rechtop voor sneller invullen.</div>
            </div>
          </div>

          <!-- STEP: LOBBY -->
          <div id="stepLobby" style="display:none;">
            <div class="cardTitle">Je bent verbonden</div>
            <div class="kicker">Als iedereen klaar is, start de host de ronde.</div>

            <div class="successText">Verbonden als <strong id="myName"></strong>.</div>
            <div class="divider"></div>

            <div class="btnRowJoin">
              <button class="btn btnFull" id="readyBtn">Ik ben ready ✅</button>
              <button class="btn btnSecondary btnFull" id="unreadyBtn" style="display:none;">Toch niet ready</button>
            </div>

            <div class="hint" id="status" style="margin-top:10px;"></div>
          </div>

          <!-- STEP: ANSWER -->
          <div id="stepAnswer" style="display:none;">
            <div class="cardTitle">Invullen</div>
            <div class="kicker"><strong>Beantwoord de stelling op het scherm.</strong></div>

            <div class="formStack">
              <div>
                <label class="label" for="selfAnswer">Mijn antwoord</label>
                <input class="input" id="selfAnswer" placeholder="Typ jouw antwoord…" maxlength="80"/>
              </div>

              <div>
                <div class="sectionHeader">Mijn voorspellingen</div>
                <div class="predictList" id="predictFields"></div>
              </div>

              <div class="btnRowJoin">
                <button class="btn btnFull" id="submitBtn">Versturen</button>
                <button class="btn btnSecondary btnFull" id="editBtn" style="display:none;">Aanpassen</button>
              </div>

              <div class="hint" id="answerHint"></div>
            </div>
          </div>

          <!-- STEP: WAIT -->
          <div id="stepWait" style="display:none;">
            <div class="cardTitle">Even wachten…</div>
            <div class="kicker">De host toont zo de antwoorden op het scherm.</div>
            <div class="hint" id="waitText">Wachten…</div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const roomCode = location.pathname.split("/").pop().toUpperCase();
    document.getElementById("roomCode").textContent = roomCode;

    const socket = io();

    let playerId = null;
    let myName = "";
    let currentPlayers = [];
    let submitted = false;

    // NEW: track last question so we can reset UI when a new question starts
    let lastQuestionKey = null;

    // join
    const nameEl = document.getElementById("name");
    document.getElementById("joinBtn").onclick = () => {
      document.getElementById("joinError").textContent = "";
      socket.emit("joinRoom", { roomCode, name: nameEl.value.trim() });
    };

    socket.on("joinError", (msg) => {
      document.getElementById("joinError").textContent = msg;
    });

    socket.on("joined", ({ playerId: pid, name }) => {
      playerId = pid;
      myName = name;

      // Update header title met spelernaam
      document.getElementById("headerTitle").textContent = myName;

      show("stepLobby");
      document.getElementById("myName").textContent = myName;
      document.getElementById("status").textContent = "Wachten tot iedereen ready is…";
    });

    // ready toggle
    const readyBtn = document.getElementById("readyBtn");
    const unreadyBtn = document.getElementById("unreadyBtn");

    readyBtn.onclick = () => {
      socket.emit("setReady", { roomCode, playerId, ready: true });
      readyBtn.style.display = "none";
      unreadyBtn.style.display = "block";
    };

    unreadyBtn.onclick = () => {
      socket.emit("setReady", { roomCode, playerId, ready: false });
      unreadyBtn.style.display = "none";
      readyBtn.style.display = "block";
    };

    // submit
    const submitBtn = document.getElementById("submitBtn");
    const editBtn = document.getElementById("editBtn");

    submitBtn.onclick = () => {
      const self = document.getElementById("selfAnswer").value.trim();

      const predicts = {};
      document.querySelectorAll("[data-predict-id]").forEach(inp => {
        predicts[inp.getAttribute("data-predict-id")] = inp.value.trim();
      });

      socket.emit("submitAnswers", { roomCode, playerId, self, predicts });
      submitted = true;

      // Disable alle inputs en behoud waarden
      document.getElementById("selfAnswer").disabled = true;
      document.querySelectorAll("[data-predict-id]").forEach(inp => {
        inp.disabled = true;
      });

      submitBtn.style.display = "none";
      editBtn.style.display = "block";
      document.getElementById("answerHint").textContent = "Verstuurd ✅ Wachten op de rest…";
    };

    editBtn.onclick = () => {
      submitted = false;
      
      // Enable alle inputs weer
      document.getElementById("selfAnswer").disabled = false;
      document.querySelectorAll("[data-predict-id]").forEach(inp => {
        inp.disabled = false;
      });

      submitBtn.style.display = "block";
      editBtn.style.display = "none";
      document.getElementById("answerHint").textContent = "";
    };

    // room state
    socket.on("roomState", (state) => {
      currentPlayers = state.players || [];
      if (!playerId) return;

      const me = currentPlayers.find(p => p.id === playerId);

      if (state.state === "LOBBY") {
        show("stepLobby");
        if (me) {
          document.getElementById("status").textContent = me.ready
            ? "Ready! ✅ Wachten op host…"
            : "Niet ready. Klik ready als je wil starten.";
        }

        // reset everything when going back to lobby
        submitted = false;
        lastQuestionKey = null;
        resetAnswerUI();
      }

      if (state.state === "ANSWERING") {
        // NEW: detect new question and reset old answers/predictions
        const questionKey = `${state.round || 1}-${state.question || 0}`;
        if (questionKey !== lastQuestionKey) {
          lastQuestionKey = questionKey;
          submitted = false;
          resetAnswerUI();
        }

        show("stepAnswer");
        buildPredictFields(currentPlayers, playerId);

        if (submitted) {
          // Disable alle inputs en behoud waarden
          document.getElementById("selfAnswer").disabled = true;
          document.querySelectorAll("[data-predict-id]").forEach(inp => {
            inp.disabled = true;
          });
          
          submitBtn.style.display = "none";
          editBtn.style.display = "block";
          document.getElementById("answerHint").textContent = "Verstuurd ✅ Wachten op de rest…";
        } else {
          // Enable alle inputs
          document.getElementById("selfAnswer").disabled = false;
          document.querySelectorAll("[data-predict-id]").forEach(inp => {
            inp.disabled = false;
          });
          
          submitBtn.style.display = "block";
          editBtn.style.display = "none";
          document.getElementById("answerHint").textContent = "";
        }
      }

      if (state.state === "REVEAL" || state.state === "SCOREBOARD") {
        show("stepWait");
        document.getElementById("waitText").textContent =
          (state.state === "REVEAL")
            ? "Host toont nu de antwoorden op het scherm…"
            : "Scoreboard op het scherm!";
      }
    });

    function show(id) {
      ["stepName", "stepLobby", "stepAnswer", "stepWait"].forEach(x => {
        document.getElementById(x).style.display = (x === id) ? "block" : "none";
      });
    }

    function buildPredictFields(players, myId) {
      const wrap = document.getElementById("predictFields");
      
      // Behoud bestaande waarden en disabled state
      const existingData = {};
      document.querySelectorAll("[data-predict-id]").forEach(inp => {
        const id = inp.getAttribute("data-predict-id");
        existingData[id] = {
          value: inp.value,
          disabled: inp.disabled
        };
      });
      
      // Verwijder velden voor spelers die er niet meer zijn
      const currentPlayerIds = players.filter(p => p.id !== myId).map(p => p.id);
      document.querySelectorAll("[data-predict-id]").forEach(inp => {
        const id = inp.getAttribute("data-predict-id");
        if (!currentPlayerIds.includes(id)) {
          inp.closest(".predictItem")?.remove();
        }
      });
      
      // Voeg nieuwe velden toe of update bestaande
      players
        .filter(p => p.id !== myId)
        .forEach(p => {
          let existingInput = document.querySelector(`[data-predict-id="${p.id}"]`);
          
          if (existingInput) {
            // Update alleen de naam als die veranderd is
            const whoEl = existingInput.previousElementSibling;
            if (whoEl && whoEl.classList.contains("predictWho")) {
              whoEl.textContent = `Het antwoord van ${escapeHtml(p.name)} is...`;
            }
          } else {
            // Maak nieuw veld
            const div = document.createElement("div");
            div.className = "predictItem";
            const savedData = existingData[p.id] || {};
            div.innerHTML = `
              <div class="predictWho">Het antwoord van ${escapeHtml(p.name)} is...</div>
              <input class="input" data-predict-id="${p.id}" placeholder="Jouw voorspelling…" maxlength="80" value="${escapeHtml(savedData.value || "")}" ${savedData.disabled ? 'disabled' : ''}/>
            `;
            wrap.appendChild(div);
          }
        });
    }

    function resetAnswerUI() {
      document.getElementById("selfAnswer").value = "";
      document.getElementById("predictFields").innerHTML = "";
      document.getElementById("answerHint").textContent = "";
      submitBtn.style.display = "block";
      editBtn.style.display = "none";
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
  </script>
</body>
</html>
