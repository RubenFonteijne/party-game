<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Party Game â€” Host</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 20px; }
    .wrap { display: grid; grid-template-columns: 360px 1fr; gap: 24px; align-items: start; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    #qr { width: 320px; height: 320px; object-fit: contain; background: #fafafa; border-radius: 12px; }
    .muted { color: #666; }
    .players li { margin: 8px 0; }
    .pill { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; border: 1px solid #ddd; }
    .ok { border-color: #2ecc71; }
    .no { border-color: #f39c12; }
    .off { border-color: #e74c3c; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Host scherm</h1>
  <p class="muted">Laat spelers de QR scannen om mee te doen.</p>

  <div class="wrap">
    <div class="card">
      <h2>Room: <span id="roomCode"></span></h2>
      <img id="qr" alt="QR code" />
      <p class="muted">Join link:</p>
      <p><code id="joinLink"></code></p>
      <p class="muted" style="margin-top:12px">
        Tip: Open dit host-scherm via je laptop IP (niet localhost), zodat de QR meteen werkt op telefoons.
      </p>
    </div>

    <div class="card">
      <h2>Spelers</h2>
      <p class="muted"><span id="count"></span> / <span id="max"></span></p>
      <ul class="players" id="players"></ul>
      <p class="muted" id="errors"></p>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const roomCode = location.pathname.split("/").pop().toUpperCase();
    document.getElementById("roomCode").textContent = roomCode;

    const joinUrl = `${location.origin}/join/${roomCode}`;
    document.getElementById("joinLink").textContent = joinUrl;

    // QR ophalen (server-side)
    fetch(`/api/qr?text=${encodeURIComponent(joinUrl)}`)
      .then(r => r.json())
      .then(data => {
        if (data.dataUrl) document.getElementById("qr").src = data.dataUrl;
      });

    const socket = io();
    socket.emit("hostSubscribe", { roomCode });

    socket.on("roomState", (state) => {
      document.getElementById("max").textContent = state.maxPlayers;
      document.getElementById("count").textContent = state.players.length;

      const ul = document.getElementById("players");
      ul.innerHTML = "";

      state.players.forEach((p, idx) => {
        const li = document.createElement("li");

        const status = p.connected ? (p.ready ? "Ready" : "Niet ready") : "Offline";
        const cls = p.connected ? (p.ready ? "ok" : "no") : "off";

        li.innerHTML = `
          <strong>${idx + 1}. ${escapeHtml(p.name)}</strong>
          <span class="pill ${cls}">${status}</span>
        `;
        ul.appendChild(li);
      });
    });

    socket.on("errorMessage", (msg) => {
      document.getElementById("errors").textContent = msg;
    });

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
  </script>
</body>
</html>
