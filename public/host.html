<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Party Game — Host</title>
  <link rel="stylesheet" href="/css/style.css">

  <style>
    /* Hide panel background in ANSWERING view */
    body.answering-view .panel {
      background: transparent;
      border: none;
      box-shadow: none;
    }
    
    body.answering-view .panelInner {
      background: transparent;
    }
    
    body.answering-view .card {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
    }
    
    body.answering-view .wrap {
      padding: 0;
    }

    /* Presentatie ANSWERING view: prompt exact in het midden */
    #viewAnswering {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 28px;
      overflow: hidden;
      z-index: 10;
    }

    #centerPrompt {
      font-size: clamp(34px, 5vw, 72px);
      font-weight: 800;
      line-height: 1.05;
      letter-spacing: -0.02em;
      max-width: 1200px;
    }

    /* Onderaan: rondjes met namen (alleen spelers) */
    #answeringSlots {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 24px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 14px;
      padding: 0 16px;
      z-index: 20;
      max-width: 1200px;
      width: 100%;
      pointer-events: none;
    }

    .slot.slotMini {
      width: 86px;
      height: 86px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      padding: 10px;
      text-align: center;
    }

    .slot.slotMini .slotName {
      font-size: 14px;
      line-height: 1.1;
      max-width: 76px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Groene glow bij ingestuurd */
    .slotSubmitted {
      box-shadow:
        0 0 0 2px rgba(64, 255, 128, 0.35),
        0 0 22px rgba(64, 255, 128, 0.35);
    }
  </style>
</head>

<body>
  <div class="streak"></div>
  <div class="streak s2"></div>
  <div class="streak s3"></div>

  <div class="header" id="topHeader">
    <h1 class="title" id="topTitle">Host scherm</h1>
    <div class="subtitle">Room: <span id="roomCode"></span> — <span id="roundNr">Ronde 1</span></div>
  </div>

  <div class="wrap">
    <div class="panel" id="panel">
      <div class="panelInner" id="panelInner">

        <!-- LEFT (Lobby only): Join -->
        <div class="card" id="joinCard">
          <div class="joinTop">
            <div class="viewTitle">Join</div>
            <div class="roomPill">Room: <strong id="roomCode2"></strong></div>
          </div>

          <div class="qrWrap">
            <div class="qrGlow"></div>
            <img id="qr" alt="QR code" />
          </div>

          <div style="margin-top: 12px;">
            <div class="muted" style="margin-bottom:6px;">Join link:</div>
            <code id="joinLink"></code>
          </div>

          <div class="btnRow">
            <button class="btn" id="startBtn" disabled>Start game</button>
          </div>

          <div class="muted" id="hostHint" style="margin-top:10px;"></div>
          <div class="errors" id="errors"></div>
        </div>

        <!-- RIGHT: Main -->
        <div class="card" id="mainCard">

          <!-- LOBBY -->
          <div id="viewLobby">
            <div class="rightTop">
              <div>
                <div class="viewTitle">Spelers</div>
                <div class="muted">Iedereen ready? Dan kun je starten.</div>
              </div>
              <div class="count"><span id="count">0</span> / <span id="max">6</span></div>
            </div>
            <div class="slots" id="slots"></div>
          </div>

          <!-- ANSWERING (presentatie) -->
          <div id="viewAnswering" style="display:none;">
            <div id="centerPrompt">…</div>
          </div>

          <!-- Onderaan: spelers rondjes tijdens answering -->
          <div id="answeringSlots" style="display:none;"></div>

          <!-- REVEAL -->
          <div id="viewReveal" style="display:none;">
            <div class="viewTitle">Reveal</div>

            <div class="revealBox">
              <div class="muted" id="targetLabel"></div>
              <div class="bigAnswer" id="targetAnswer"></div>

              <div id="predictionsList" style="margin-top:14px;"></div>

              <div style="margin-top:14px;">
                <button class="btn" id="nextRevealBtn">Volgende speler</button>
              </div>
            </div>
          </div>

          <!-- SCOREBOARD -->
          <div id="viewScore" style="display:none;">
            <div class="viewTitle">Scoreboard</div>

            <table>
              <thead>
                <tr><th>Speler</th><th>Score</th></tr>
              </thead>
              <tbody id="scoreRows"></tbody>
            </table>

            <div style="margin-top:14px;">
              <button class="btn btnSecondary" id="nextQuestionBtn">Volgende vraag</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const roomCode = location.pathname.split("/").pop().toUpperCase();
    document.getElementById("roomCode").textContent = roomCode;
    document.getElementById("roomCode2").textContent = roomCode;

    const joinUrl = `${location.origin}/join/${roomCode}`;
    document.getElementById("joinLink").textContent = joinUrl;

    fetch(`/api/qr?text=${encodeURIComponent(joinUrl)}`)
      .then(r => r.json())
      .then(data => { if (data.dataUrl) document.getElementById("qr").src = data.dataUrl; });

    const socket = io();
    socket.emit("hostSubscribe", { roomCode });

    // Buttons
    const startBtn = document.getElementById("startBtn");
    const nextRevealBtn = document.getElementById("nextRevealBtn");
    const nextQuestionBtn = document.getElementById("nextQuestionBtn");

    startBtn.onclick = () => socket.emit("hostStartGame", { roomCode });
    nextRevealBtn.onclick = () => socket.emit("hostNextReveal", { roomCode });
    nextQuestionBtn.onclick = () => socket.emit("hostNextQuestion", { roomCode });

    socket.on("errorMessage", (msg) => {
      document.getElementById("errors").textContent = msg;
    });

    socket.on("roomState", (state) => {
      document.getElementById("max").textContent = state.maxPlayers;
      document.getElementById("count").textContent = state.players.length;

      document.getElementById("roundNr").textContent =
        state.question
          ? `Ronde ${state.round} — Vraag ${state.question}/${state.questionsPerRound}`
          : `Ronde ${state.round ?? 1}`;

      renderSlots(state.players);

      const topTitle = document.getElementById("topTitle");
      if (state.state === "LOBBY") topTitle.textContent = "Host scherm";
      else topTitle.textContent = state.prompt || "…";

      // Midden prompt in answering view
      const centerPrompt = document.getElementById("centerPrompt");
      if (centerPrompt) centerPrompt.textContent = state.prompt || "…";

      setLobbyLayout(state.state === "LOBBY");

      const connected = state.players.filter(p => p.connected);
      const canStart = (state.state === "LOBBY")
        && connected.length >= 2
        && connected.every(p => p.ready);

      startBtn.disabled = !canStart;

      showView(state.state);

      if (state.state === "ANSWERING") {
        renderAnsweringSlots(state.players, state);
      }

      if (state.state === "REVEAL") {
        const rd = state.revealData;
        if (!rd) return;

        document.getElementById("targetLabel").textContent = `Antwoord van ${rd.targetName}`;
        document.getElementById("targetAnswer").textContent = rd.targetAnswer || "(leeg)";

        renderPredictionsList(rd.predictors);
      }

      if (state.state === "SCOREBOARD") {
        renderScoreboard(state.players);

        const q = state.question || 0;
        const total = state.questionsPerRound || 10;
        const isLastQuestion = q >= total;

        nextQuestionBtn.textContent = isLastQuestion
          ? "Nieuwe ronde"
          : `Volgende vraag (${q + 1}/${total})`;
      }

      document.getElementById("hostHint").textContent =
        (state.state === "LOBBY") ? "Tip: iedereen moet Ready zijn (min. 2 spelers) om te starten." : "";
      document.getElementById("errors").textContent = "";
    });

    function setLobbyLayout(isLobby) {
      const joinCard = document.getElementById("joinCard");
      const panelInner = document.getElementById("panelInner");

      if (isLobby) {
        joinCard.style.display = "block";
        panelInner.style.gridTemplateColumns = "360px 1fr";
      } else {
        joinCard.style.display = "none";
        panelInner.style.gridTemplateColumns = "1fr";
      }
    }

    function showView(gameState) {
      // Header verbergen in ANSWERING voor clean presentatie
      const topHeader = document.getElementById("topHeader");
      topHeader.style.display = (gameState === "ANSWERING") ? "none" : "block";

      // Add/remove class to body for ANSWERING view styling
      if (gameState === "ANSWERING") {
        document.body.classList.add("answering-view");
      } else {
        document.body.classList.remove("answering-view");
      }

      document.getElementById("viewLobby").style.display = (gameState === "LOBBY") ? "block" : "none";
      document.getElementById("viewAnswering").style.display = (gameState === "ANSWERING") ? "flex" : "none";
      document.getElementById("answeringSlots").style.display = (gameState === "ANSWERING") ? "flex" : "none";
      document.getElementById("viewReveal").style.display = (gameState === "REVEAL") ? "block" : "none";
      document.getElementById("viewScore").style.display = (gameState === "SCOREBOARD") ? "block" : "none";
    }

    function renderSlots(players) {
      const wrap = document.getElementById("slots");
      if (!wrap) return;
      wrap.innerHTML = "";

      // Lobby: 6 plekken (zoals origineel)
      for (let i = 0; i < 6; i++) {
        const p = players[i];
        const div = document.createElement("div");

        if (!p) {
          div.className = "slot slotEmpty";
          div.innerHTML = `<div class="slotName">?</div>`;
          wrap.appendChild(div);
          continue;
        }

        const statusClass = !p.connected
          ? "slotOffline"
          : (p.ready ? "slotReady" : "slotNotReady");

        div.className = `slot ${statusClass}`;
        div.title = p.connected ? (p.ready ? "Ready" : "Niet ready") : "Offline";
        div.innerHTML = `<div class="slotName">${escapeHtml(p.name)}</div>`;
        wrap.appendChild(div);
      }
    }

    function renderAnsweringSlots(players, state) {
      const wrap = document.getElementById("answeringSlots");
      if (!wrap) return;

      wrap.innerHTML = "";

      // Alleen echte spelers
      players.forEach(p => {
        const div = document.createElement("div");

        const baseClass = !p.connected ? "slotOffline" : "slotReady";
        const isSubmitted = getSubmittedFlag(p, state);

        div.className = `slot slotMini ${baseClass} ${isSubmitted ? "slotSubmitted" : ""}`;
        div.title = isSubmitted ? "Ingestuurd ✅" : "Nog niet ingestuurd";
        div.innerHTML = `<div class="slotName">${escapeHtml(p.name)}</div>`;
        wrap.appendChild(div);
      });
    }

    function getSubmittedFlag(p, state) {
      if (!p) return false;

      // NEW: server stuurt submittedIds naar host
      if (state && Array.isArray(state.submittedIds) && state.submittedIds.includes(p.id)) return true;

      // fallback (voor het geval je later nog andere structuren gebruikt)
      if (p.submitted === true) return true;
      if (p.hasSubmitted === true) return true;
      if (p.answered === true) return true;
      if (p.didSubmit === true) return true;

      if (state && state.submissions && p.id && state.submissions[p.id]) return true;
      if (state && state.answers && p.id && state.answers[p.id]) return true;

      return false;
    }

    function renderScoreboard(players) {
      const rows = document.getElementById("scoreRows");
      rows.innerHTML = "";

      [...players]
        .sort((a,b) => (b.score||0) - (a.score||0))
        .forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${p.score || 0}</td>`;
          rows.appendChild(tr);
        });
    }

    // Reveal: alle voorspellingen direct onder elkaar (geen animatie)
    function renderPredictionsList(predictors) {
      const wrap = document.getElementById("predictionsList");
      if (!wrap) return;

      if (!predictors || predictors.length === 0) {
        wrap.innerHTML = `<div class="muted">Geen voorspellingen.</div>`;
        return;
      }

      wrap.innerHTML = predictors.map(p => {
        const name = p.predictorName ?? p.name ?? "Onbekend";
        const ans = (p.predicted ?? p.answer ?? "").toString() || "(leeg)";
        const plus = p.match ? ` <strong>+1</strong>` : "";
        return `<div class="predRow">${escapeHtml(name)} — ${escapeHtml(ans)}${plus}</div>`;
      }).join("");

      wrap.style.display = "grid";
      wrap.style.gap = "8px";
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
  </script>
</body>
</html>